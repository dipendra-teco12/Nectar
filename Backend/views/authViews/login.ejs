<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nectar | Log in</title>

    <!-- Google Font: Source Sans Pro -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- icheck bootstrap -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/icheck-bootstrap/3.0.1/icheck-bootstrap.min.css"
    />

    <!-- Bootstrap 4 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css"
    />

    <!-- Theme style -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css"
    />

    <style>
      .error-message {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
        display: block;
      }

      .is-invalid {
        border-color: #dc3545 !important;
      }
    </style>
  </head>

  <body class="hold-transition login-page">
    <div class="login-box">
      <div class="card card-outline card-primary">
        <div class="card-header text-center">
          <a href="/admin/dashboard" class="h1"><b>Nectar</b></a>
        </div>
        <div class="card-body">
          <p class="login-box-msg">Sign in to start your session</p>

          <form id="login-form" novalidate>
            <div class="input-group mb-3">
              <input
                type="email"
                class="form-control"
                placeholder="Email"
                name="email"
                id="email"
                required
              />
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-envelope"></span>
                </div>
              </div>
            </div>
            <div class="error-message" id="emailError"></div>

            <div class="input-group mb-3">
              <input
                type="password"
                class="form-control"
                placeholder="Password"
                name="password"
                id="password"
                required
              />
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-lock"></span>
                </div>
              </div>
            </div>
            <div class="error-message" id="passwordError"></div>

            <div class="row">
              <div class="col-8">
                <!-- Optionally "Remember me" here -->
              </div>
              <div class="col-4">
                <button
                  type="submit"
                  id="submitBtn"
                  class="btn btn-primary btn-block"
                >
                  Sign in
                </button>
              </div>
            </div>
          </form>
          <div class="social-auth-links text-center mb-3">
            <p>- OR -</p>

            <a href="/auth/google" class="btn btn-block btn-danger">
              <i class="fab fa-google-plus mr-2"></i> Sign in using Google+
            </a>
          </div>
          <div id="login-message" class="mt-3"></div>

          <p class="mb-1">
            <a href="/admin/forgot-password">I forgot my password</a>
          </p>
          <!-- <p class="mb-0">
            <a href="/register" class="text-center"
              >Register a new membership</a
            >
          </p> -->
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>

    <script>
      $(function () {
        const setError = (id, msg) => {
          const errorElement = $("#" + id + "Error");
          const inputElement = $("#" + id);
          if (msg) {
            errorElement.text(msg).show();
            inputElement.addClass("is-invalid");
          } else {
            errorElement.text("").hide();
            inputElement.removeClass("is-invalid");
          }
        };

        const clearError = (id) => {
          setError(id, "");
        };

        // Clear errors on input
        $("#email, #password").on("input", function () {
          clearError(this.id);
        });

        function validateForm() {
          let valid = true;
          const email = $("#email").val().trim();
          const password = $("#password").val();

          clearError("email");
          clearError("password");

          if (!email) {
            setError("email", "Email is required.");
            valid = false;
          } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            setError("email", "Enter a valid email.");
            valid = false;
          }

          if (!password) {
            setError("password", "Password is required.");
            valid = false;
          } else if (password.length < 6) {
            setError("password", "Password must be at least 6 characters.");
            valid = false;
          }

          return valid;
        }

        $("#login-form").on("submit", function (e) {
          e.preventDefault();
          if (!validateForm()) return;

          const email = $("#email").val().trim();
          const password = $("#password").val();
          const $submitBtn = $("#submitBtn");

          $submitBtn.prop("disabled", true).text("Signing In...");

          $.ajax({
            url: "/api/auth/login",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ email, password }),
            success: function (res) {
              window.location.href = "/admin/dashboard";
            },
            error: function (xhr) {
              const status = xhr.status;
              const response = xhr.responseJSON || {};
              const message = response.message || "Login failed.";

              if (status === 401) {
                setError("password", "Invalid email or password.");
              } else if (status === 404) {
                setError("email", "Account not found.");
              } else if (status === 422 && response.errors) {
                if (response.errors.email)
                  setError("email", response.errors.email);
                if (response.errors.password)
                  setError("password", response.errors.password);
              } else {
                alert(message);
              }
            },
            complete: function () {
              $submitBtn.prop("disabled", false).text("Sign in");
            },
          });
        });

        $("#email, #password").on("keypress", function (e) {
          if (e.which === 13) $("#login-form").submit();
        });
      });
    </script>
  </body>
</html>
