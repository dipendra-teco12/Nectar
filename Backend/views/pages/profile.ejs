<style>
  .form-control {
    height: 40px;
    padding: 10px;
    box-sizing: border-box;
  }

  .text-danger {
    font-size: 0.875rem;
    color: #dc3545;
    margin-top: 5px;
    min-height: 20px;
    padding-left: 5px;
  }

  .mb-3 {
    position: relative;
  }

  .text-danger {
    margin-top: 8px;
  }
</style>

<div class="card">
  <div class="card-body">
    <div class="mb-3 row">
      <div class="col-sm-6">
        <label for="fullName">Full Name</label>
        <input
          type="text"
          name="fullName"
          id="fullName"
          class="form-control"
          value="<%= user.fullName || '' %>"
          required
          minlength="2"
          disabled
        />
        <div class="text-danger mt-1" id="fullNameError"></div>
      </div>

      <div class="col-sm-6">
        <label for="email">Email address</label>
        <input
          type="email"
          name="email"
          id="email"
          class="form-control"
          value="<%= user.email || '' %>"
          required
          disabled
        />
        <div class="text-danger mt-1" id="emailError"></div>
      </div>
    </div>

    <button type="button" id="btnShowPasswordCard" class="btn btn-primary">
      Change Password
    </button>
  </div>
</div>

<div class="card" id="passwordCard" style="display: none">
  <div class="card-body">
    <form id="passwordForm" novalidate>
      <div class="mb-3 row">
        <div class="col-sm-4">
          <label for="currentPassword">Current Password</label>
          <input
            type="password"
            name="currentPassword"
            id="currentPassword"
            class="form-control"
            required
            minlength="8"
          />
          <div class="text-danger" id="currentPasswordError"></div>
        </div>
        <div class="col-sm-4">
          <label for="newPassword">New Password</label>
          <input
            type="password"
            name="newPassword"
            id="newPassword"
            class="form-control"
            required
            minlength="8"
          />
          <div class="text-danger" id="newPasswordError"></div>
        </div>
        <div class="col-sm-4">
          <label for="confirmPassword">Confirm Password</label>
          <input
            type="password"
            name="confirmPassword"
            id="confirmPassword"
            class="form-control"
            required
            minlength="8"
          />
          <div class="text-danger" id="confirmPasswordError"></div>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Update Password</button>
    </form>
  </div>
</div>
<script>
  $(document).ready(function () {
    $("#btnShowPasswordCard").on("click", function () {
      $(this).hide();
      $("#passwordCard").slideDown();
    });

    const setError = (fldId, msg) => {
      $("#" + fldId + "Error").text(msg || "");
    };

    function validatePasswordForm() {
      let valid = true;
      setError("currentPassword", "");
      setError("newPassword", "");
      setError("confirmPassword", "");

      const cur = $("#currentPassword").val().trim();
      const nw = $("#newPassword").val().trim();
      const cp = $("#confirmPassword").val().trim();

      if (!cur) {
        setError("currentPassword", "Old password is required.");
        valid = false;
      } else if (cur.length < 8) {
        setError("currentPassword", "Password must be at least 8 characters.");
        valid = false;
      }

      if (!nw) {
        setError("newPassword", "New password is required.");
        valid = false;
      } else if (nw.length < 8) {
        setError("newPassword", "Password must be at least 8 characters.");
        valid = false;
      }

      if (!cp) {
        setError("confirmPassword", "Please confirm password.");
        valid = false;
      } else if (cp !== nw) {
        setError("confirmPassword", "Passwords do not match.");
        valid = false;
      }

      return valid;
    }

    $("#passwordForm input").on("input change", function () {
      setError(this.id, "");
    });

    $("#passwordForm").on("submit", function (e) {
      e.preventDefault();
      if (!validatePasswordForm()) {
        return;
      }

      showModal({
        title: "Update Password",
        message: "Are you sure you want to change your password?",
        confirmText: "Yes, Change",
        onConfirm: function () {
          const btn = $("#passwordForm")
            .find("button[type='submit']")
            .prop("disabled", true)
            .text("Updating...");

          const data = {
            currentPassword: $("#currentPassword").val(),
            newPassword: $("#newPassword").val(),
            confirmPassword: $("#confirmPassword").val(),
          };

          $.ajax({
            url: "/api/auth/update-profile",
            type: "PATCH",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (res) {
              showModal({
                title: "Success",
                message: res.message || "Password changed successfully",
                confirmText: "OK",
              });
              setTimeout(() => location.reload(), 150);
            },
            error: function (xhr) {
              if (
                xhr.status === 422 &&
                xhr.responseJSON &&
                Array.isArray(xhr.responseJSON.error)
              ) {
                xhr.responseJSON.error.forEach((errObj) => {
                  setError(errObj.name, errObj.message);
                });
              } else {
                showModal({
                  title: "Error",
                  message: xhr.responseJSON?.message || "Operation failed",
                  confirmText: "Close",
                });
              }
            },
            complete: function () {
              btn.prop("disabled", false).text("Update Password");
            },
          });
        },
      });
    });
  });
</script>
