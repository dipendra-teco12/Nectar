<section class="content">
  <div class="container-fluid">
    <div class="row">
      <!-- left column -->
      <div class="col-md-12">
        <!-- jquery validation -->
        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">Fill Product Details <small></small></h3>
          </div>
          <!-- /.card-header -->
          <!-- form start -->
          <form id="quickForm" enctype="multipart/form-data">
            <div class="card-body">
              <div class="row">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label for="productName"
                      >Product Name <span style="color: red">*</span></label
                    >
                    <input
                      type="text"
                      name="productName"
                      class="form-control"
                      id="productName"
                      placeholder="Enter product name.."
                    />
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label for="price"
                      >Price <span style="color: red">*</span></label
                    >
                    <input
                      type="number"
                      name="price"
                      class="form-control"
                      id="price"
                      placeholder="Enter product price .."
                      step="0.01"
                    />
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label for="stock"
                      >Stock <span style="color: red">*</span></label
                    >
                    <input
                      type="number"
                      name="stock"
                      class="form-control"
                      id="stock"
                      placeholder="Enter product stock"
                    />
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label>Categories <span style="color: red">*</span></label>
                    <select
                      class="form-control"
                      id="genreSelect"
                      name="category"
                      required
                    >
                      <option value="">--Select--</option>
                      <option value="Fresh Fruits & Vegetable">
                        Fresh Fruits & Vegetable
                      </option>
                      <option value="Cooking Oil">Cooking Oil</option>
                      <option value="Meat & Fish">Meat & Fish</option>
                      <option value="Bakery & Snacks">Bakery & Snacks</option>
                      <option value="Dairy & Eggs">Dairy & Eggs</option>
                      <option value="Beverages">Beverages</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label>Description <span style="color: red">*</span></label>
                    <textarea
                      class="form-control"
                      rows="3"
                      name="description"
                      id="description"
                      placeholder="Enter product description.."
                    ></textarea>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label for="productImage"
                      >Product Image <span style="color: red">*</span></label
                    >
                    <div class="custom-file">
                      <input
                        type="file"
                        class="custom-file-input"
                        id="productImage"
                        name="image"
                        accept="image/*"
                      />
                      <label class="custom-file-label" for="productImage"
                        >Choose file</label
                      >
                    </div>
                    <!-- Image preview -->
                    <div
                      id="imagePreview"
                      style="margin-top: 10px; display: none"
                    >
                      <img
                        id="previewImg"
                        src=""
                        alt="Preview"
                        style="
                          max-width: 200px;
                          max-height: 200px;
                          border-radius: 5px;
                        "
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.card-body -->
            <div class="card-footer">
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <span id="btnText">Submit</span>
                <span
                  id="btnSpinner"
                  class="spinner-border spinner-border-sm ml-2"
                  style="display: none"
                ></span>
              </button>
            </div>
          </form>
        </div>
        <!-- /.card -->
      </div>
      <!--/.col (left) -->
    </div>
    <!-- /.row -->
  </div>
  <!-- /.container-fluid -->
</section>
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Upload</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <i
          class="fas fa-question-circle text-warning"
          style="font-size: 48px; margin-bottom: 10px"
        ></i>
        <p>Are you sure you want to upload this product?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="confirmUpload">
          Yes, Upload
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Success</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <i
          class="fas fa-check-circle text-success"
          style="font-size: 48px; margin-bottom: 10px"
        ></i>
        <p id="successMessage">Product added successfully!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">
          OK
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Error</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <i
          class="fas fa-exclamation-triangle text-danger"
          style="font-size: 48px; margin-bottom: 10px"
        ></i>
        <p id="errorMessage">Failed to add product. Please try again.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">
          Try Again
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  $(document).ready(function () {
    console.log("Document ready");

    // Initialize once and store form reference
    let formSubmitting = false;
    let formData = null;

    // File input handling
    $(".custom-file-input").on("change", function () {
      var fileName = $(this).val().split("\\").pop();
      $(this).next(".custom-file-label").html(fileName);

      if (this.files && this.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
          $("#previewImg").attr("src", e.target.result);
          $("#imagePreview").show();
        };
        reader.readAsDataURL(this.files[0]);
      }
    });

    // Reset button state function
    function resetButtonState() {
      $("#submitBtn").prop("disabled", false);
      $("#btnText").text("Submit");
      $("#btnSpinner").hide();
      formSubmitting = false;
      console.log("Button state reset");
    }

    // Set loading state function
    function setLoadingState() {
      $("#submitBtn").prop("disabled", true);
      $("#btnText").text("Uploading...");
      $("#btnSpinner").show();
      formSubmitting = true;
      console.log("Loading state set");
    }

    // Custom validation methods
    $.validator.addMethod(
      "filesize",
      function (value, element, param) {
        return (
          this.optional(element) ||
          (element.files[0] && element.files[0].size <= param)
        );
      },
      "File must be less than 10 MB"
    );

    $.validator.addMethod(
      "extension",
      function (value, element, param) {
        var ext = value.split(".").pop().toLowerCase();
        return this.optional(element) || param.split("|").includes(ext);
      },
      "Please select a valid file format"
    );

    // Initialize validation - ONLY ONCE
    const validator = $("#quickForm").validate({
      rules: {
        productName: { required: true, minlength: 2 },
        price: { required: true, number: true, min: 0.01 },
        stock: { required: true, digits: true, min: 0 },
        category: { required: true },
        description: { required: true, minlength: 10 },
        image: {
          required: true,
          extension: "jpg|jpeg|png|gif|webp",
          filesize: 10 * 1024 * 1024,
        },
      },
      messages: {
        productName: {
          required: "Please enter the product name",
          minlength: "Product name must be at least 2 characters",
        },
        price: {
          required: "Please enter the product price",
          number: "Please enter a valid number",
          min: "Price must be at least Rs. 0.01",
        },
        stock: {
          required: "Please enter stock quantity",
          digits: "Stock must be a whole number",
          min: "Stock cannot be negative",
        },
        category: { required: "Please select a category" },
        description: {
          required: "Please enter product description",
          minlength: "Description must be at least 10 characters",
        },
        image: {
          required: "Please upload a product image",
          extension: "Only jpg, jpeg, png, gif, webp files are allowed",
          filesize: "Image must be less than 10 MB",
        },
      },
      errorElement: "span",
      errorPlacement: function (error, element) {
        error.addClass("invalid-feedback");
        element.closest(".form-group").append(error);
      },
      highlight: function (element) {
        $(element).addClass("is-invalid");
      },
      unhighlight: function (element) {
        $(element).removeClass("is-invalid");
      },
      submitHandler: function (form) {
        console.log("Form submit handler called");

        // Prevent multiple submissions
        if (formSubmitting) {
          console.log("Form already submitting, ignoring...");
          return false;
        }

        // Store form data
        formData = new FormData(form);

        // Show confirmation modal
        $("#confirmModal").modal("show");
        return false; // Prevent form submission
      },
    });

    // Handle confirmation modal - ONE TIME BINDING
    $("#confirmUpload")
      .off("click")
      .on("click", function () {
        console.log("Confirm upload clicked");

        if (formSubmitting) {
          console.log("Already submitting, ignoring confirm click");
          return;
        }

        // Hide confirmation modal
        $("#confirmModal").modal("hide");

        // Set loading state
        setLoadingState();

        // Submit form data
        $.ajax({
          url: "/api/product/add",
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          timeout: 30000, // 30 second timeout
          success: function (response) {
            console.log("Success response:", response);

            $("#successMessage").text(
              response.message || "Product added successfully!"
            );
            $("#successModal").modal("show");
          },
          error: function (xhr, status, error) {
            console.error("Error:", error, xhr);

            let errorMessage = "Failed to add product. Please try again.";
            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMessage = xhr.responseJSON.message;
            }

            $("#errorMessage").text(errorMessage);
            $("#errorModal").modal("show");
          },
          complete: function () {
            console.log("Ajax request completed");
            resetButtonState();
          },
        });
      });

    // Handle success modal close
    $("#successModal").on("hidden.bs.modal", function () {
      console.log("Success modal closed");
      // Reset form
      document.getElementById("quickForm").reset();
      $(".custom-file-label").html("Choose file");
      $("#imagePreview").hide();
      validator.resetForm();
      $(".form-control").removeClass("is-invalid is-valid");

      // Redirect if needed
      // window.location.href = '/admin/products';
    });

    // Handle cancel in confirmation modal
    $("#confirmModal").on("hidden.bs.modal", function () {
      if (formSubmitting) {
        console.log("Confirmation modal closed while submitting");
        resetButtonState();
      }
    });

    // Error modal close
    $("#errorModal").on("hidden.bs.modal", function () {
      resetButtonState();
    });

    console.log("All event handlers initialized");
  });
</script>
