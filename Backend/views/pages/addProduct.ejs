<section class="content">
  <div class="container-fluid">
    <div class="row">
      <!-- left column -->
      <div class="col-md-12">
        <!-- jquery validation -->
        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">Fill Product Details <small></small></h3>
          </div>
          <!-- /.card-header -->
          <!-- form start -->
          <form id="quickForm" enctype="multipart/form-data">
            <div class="card-body">
              <div class="row">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label for="productName"
                      >Product Name <span style="color: red">*</span></label
                    >
                    <input
                      type="text"
                      name="productName"
                      class="form-control"
                      id="productName"
                      placeholder="Enter product name.."
                    />
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label for="price"
                      >Price <span style="color: red">*</span></label
                    >
                    <input
                      type="number"
                      name="price"
                      class="form-control"
                      id="price"
                      placeholder="Enter product price .."
                      step="0.01"
                    />
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label for="stock"
                      >Stock <span style="color: red">*</span></label
                    >
                    <input
                      type="number"
                      name="stock"
                      class="form-control"
                      id="stock"
                      placeholder="Enter product stock"
                    />
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label>Categories <span style="color: red">*</span></label>
                    <select
                      class="form-control"
                      id="genreSelect"
                      name="category"
                      required
                    >
                      <option value="">--Select--</option>
                      <option value="Fresh Fruits & Vegetable">
                        Fresh Fruits & Vegetable
                      </option>
                      <option value="Cooking Oil">Cooking Oil</option>
                      <option value="Meat & Fish">Meat & Fish</option>
                      <option value="Bakery & Snacks">Bakery & Snacks</option>
                      <option value="Dairy & Eggs">Dairy & Eggs</option>
                      <option value="Beverages">Beverages</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label>Description <span style="color: red">*</span></label>
                    <textarea
                      class="form-control"
                      rows="3"
                      name="description"
                      id="description"
                      placeholder="Enter product description.."
                    ></textarea>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label for="productImage"
                      >Product Image <span style="color: red">*</span></label
                    >
                    <div class="custom-file">
                      <input
                        type="file"
                        class="custom-file-input"
                        id="productImage"
                        name="image"
                        accept="image/*"
                      />
                      <label class="custom-file-label" for="productImage"
                        >Choose file</label
                      >
                    </div>
                    <!-- Image preview -->
                    <div
                      id="imagePreview"
                      style="margin-top: 10px; display: none"
                    >
                      <img
                        id="previewImg"
                        src=""
                        alt="Preview"
                        style="
                          max-width: 200px;
                          max-height: 200px;
                          border-radius: 5px;
                        "
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.card-body -->
            <div class="card-footer">
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <span id="btnText">Submit</span>
                <span
                  id="btnSpinner"
                  class="spinner-border spinner-border-sm ml-2"
                  style="display: none"
                ></span>
              </button>
            </div>
          </form>
        </div>
        <!-- /.card -->
      </div>
      <!--/.col (left) -->
    </div>
    <!-- /.row -->
  </div>
  <!-- /.container-fluid -->
</section>

<script>
  $(function () {
    // File input label update
    $(".custom-file-input").on("change", function () {
      var fileName = $(this).val().split("\\").pop();
      $(this).next(".custom-file-label").html(fileName);

      // Show image preview
      if (this.files && this.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
          $("#previewImg").attr("src", e.target.result);
          $("#imagePreview").show();
        };
        reader.readAsDataURL(this.files[0]);
      }
    });

    // Custom method to validate file size (< 2 MB)
    $.validator.addMethod(
      "filesize",
      function (value, element, param) {
        return (
          this.optional(element) ||
          (element.files[0] && element.files[0].size <= param)
        );
      },
      "File must be less than 2 MB"
    );

    // Custom method to validate file extension
    $.validator.addMethod(
      "extension",
      function (value, element, param) {
        var ext = value.split(".").pop().toLowerCase();
        return this.optional(element) || param.split("|").includes(ext);
      },
      "Please select a valid file format"
    );

    $("#quickForm").validate({
      rules: {
        productName: {
          required: true,
          minlength: 2,
        },
        price: {
          required: true,
          number: true,
          min: 0.01,
        },
        stock: {
          required: true,
          digits: true,
          min: 0,
        },
        category: {
          required: true,
        },
        description: {
          required: true,
          minlength: 10,
        },
        image: {
          required: true,
          extension: "jpg|jpeg|png|gif|webp",
          filesize: 2 * 1024 * 1024, // 2MB limit
        },
      },
      messages: {
        productName: {
          required: "Please enter the product name",
          minlength: "Product name must be at least 2 characters",
        },
        price: {
          required: "Please enter the product price",
          number: "Please enter a valid number",
          min: "Price must be at least Rs. 0.01",
        },
        stock: {
          required: "Please enter stock quantity",
          digits: "Stock must be a whole number",
          min: "Stock cannot be negative",
        },
        category: {
          required: "Please select a category",
        },
        description: {
          required: "Please enter product description",
          minlength: "Description must be at least 10 characters",
        },
        image: {
          required: "Please upload a product image",
          extension: "Only jpg, jpeg, png, gif, webp files are allowed",
          filesize: "Image must be less than 2 MB",
        },
      },
      errorElement: "span",
      errorPlacement: function (error, element) {
        error.addClass("invalid-feedback");
        element.closest(".form-group").append(error);
      },
      highlight: function (element, errorClass, validClass) {
        $(element).addClass("is-invalid");
      },
      unhighlight: function (element, errorClass, validClass) {
        $(element).removeClass("is-invalid");
      },
      submitHandler: function (form) {
        // Show confirmation modal first
        showModal({
          title: "Confirm Upload",
          message: `<div class="text-center">
                     <i class="fas fa-question-circle text-warning" style="font-size: 48px; margin-bottom: 10px;"></i>
                     <p>Are you sure you want to upload this product?</p>
                   </div>`,
          confirmText: "Yes, Upload",
          showCancel: true,
          onConfirm: function () {
            // Prepare form data for file upload
            var formData = new FormData(form);

            // Show loading state
            $("#submitBtn").prop("disabled", true);
            $("#btnText").text("Uploading...");
            $("#btnSpinner").show();

            // AJAX call to your API
            $.ajax({
              url: "/api/product/add", // Adjust this URL to match your API endpoint
              type: "POST",
              data: formData,
              processData: false, // Important for file upload
              contentType: false, // Important for file upload
              success: function (response) {
                // Use the global showModal function from admin.ejs
                showModal({
                  title: "Success",
                  message: `<div class="text-center">
                           <i class="fas fa-check-circle text-success" style="font-size: 48px; margin-bottom: 10px;"></i>
                           <p>${
                             response.message || "Product added successfully!"
                           }</p>
                         </div>`,
                  confirmText: "OK",
                  showCancel: false,
                  onConfirm: function () {
                    // Reset form after successful submission
                    form.reset();
                    $(".custom-file-label").html("Choose file");
                    $("#imagePreview").hide();
                    $("#quickForm").validate().resetForm();
                    $(".form-control").removeClass("is-invalid is-valid");
                  },
                });
              },
              error: function (xhr, status, error) {
                console.error("Error:", error);

                let errorMessage = "Failed to add product. Please try again.";

                if (xhr.responseJSON) {
                  errorMessage = xhr.responseJSON.message || errorMessage;
                }

                // Use the global showModal function from admin.ejs for errors
                showModal({
                  title: "Error",
                  message: `<div class="text-center">
                           <i class="fas fa-exclamation-triangle text-danger" style="font-size: 48px; margin-bottom: 10px;"></i>
                           <p>${errorMessage}</p>
                         </div>`,
                  confirmText: "Try Again",
                  showCancel: false,
                });
              },
              complete: function () {
                // Reset button state
                $("#submitBtn").prop("disabled", false);
                $("#btnText").text("Submit");
                $("#btnSpinner").hide();
              },
            });
          },
          onCancel: function () {
            // Reset button state if user cancels
            $("#submitBtn").prop("disabled", false);
            $("#btnText").text("Submit");
            $("#btnSpinner").hide();
          },
        });
      },
    });
  });
</script>
